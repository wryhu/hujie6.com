{% extends 'base.html' %}
{% block title %}博客{% endblock %}
{% block nav_blog_active %}active{% endblock %}

{% load staticfiles %}
{% load comment_tags %}

{% block header_extends %}
    <link rel="stylesheet" href="{% static 'css/blog.css' %}">
{% endblock %}

{% block content %}
    <marquee behavior="scroll" direction="left"><img id="ship" src="/static/image/fish.png"><span style="color:red">公告: 本网站租用国外服务器加载较慢，目前正在优化中，敬请谅解!&ensp;</span></marquee>
    <div class="container">
        <div class="row">
            <div class="col-sm-8 col-md-8">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <ol class="breadcrumb" style="margin:0;">
                          <li><a href="/">首页</a></li>
                          <li><a href="/blog/ajax_blog_list">博客</a></li>
                          <li class="active">{% block blog_list_title %}全部{% endblock %}</li>
                          <li style="float:right"><a href="/blog/">传统翻页模式</a></li>
                        </ol>
                    </div>
                    <div id="ajax_blog" class="panel-body">
                        {% for blog in blogs %}
                            <div class="media">
                              <div class="row">
                                <div style="overflow:hidden" class="col-md-3">
                              <div class="media-left media-middle">
                                <a href="{% url 'blog_detail' blog.pk %}">
                                  <img class="img-rounded" src="/media/{{ blog.thumbnail }}" height="150" width="150">
                                  <figcaption></figcaption>
                                </a>
                              </div>
                                </div>
                                <div class="col-md-9">
                              <div class="media-body">
                                    <h3 class="media-heading"><a href="{% url 'blog_detail' blog.pk %}">{{ blog.title }}</a></h3>
                                    <div id="content">{{ blog.content|truncatechars:100|safe }}</div>
                                    <a id="tagset" href="#">
                                    <button type="button" class="btn btn-default btn-xs">
                                        <span class="glyphicon glyphicon-grain"></span> 作者: {{ blog.author }}
                                    </button>
                                    </a>
                                    <a href="{% url 'blogs_by_type' blog.blog_type.pk %}">
                                        <button type="button" class="btn btn-default btn-xs">
                                            <span class="glyphicon glyphicon-star-empty"></span> {{ blog.blog_type }}
                                        </button>
                                    </a>
                                    <button type="button" class="btn btn-default btn-xs">
                                        <span class="glyphicon glyphicon-time"></span> {{ blog.created_time|date:"Y-m-d H:i:s" }}
                                    </button>
                                    <button type="button" class="btn btn-default btn-xs">
                                        <span class="glyphicon glyphicon-eye-open"></span> 阅读: {{ blog.get_read_num }}
                                    </button>
                                    <button type="button" class="btn btn-default btn-xs">
                                        <span class="glyphicon glyphicon-comment"></span> 评论: {% comments_count blog %}
                                    </button>
                              </div>
                                 </div>
                              </div>
                            </div>
                        {% empty %}
                            <div class="blog">
                                <p>-- 未找到相关内容 --</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>

            </div>
            <div id="music-parent" class="col-sm-4 col-md-3">
                <div class="panel panel-default">
                    <div class="panel-heading"><span class="fa fa-object-ungroup"></span> &nbsp;博客分类</div>
                    <div class="panel-body">
                        <ul class="blog-types">
                            {% for blog_type in blog_types %}
                                <li>
                                    <a href="{% url 'blogs_by_type' blog_type.pk %}">
                                        {{ blog_type.type_name }} ({{ blog_type.blog_count }})
                                    </a>
                                </li>
                            {% empty %}
                                <li>暂无此分类</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading"><span class="fa fa-calendar"></span> &nbsp;日期归档</div>
                    <div class="panel-body">
                        <ul class="blog-dates">
                            {% for blog_date, blog_count in blog_dates.items %}
                                <li>
                                    <a href="{% url 'blogs_by_date' blog_date.year blog_date.month %}">
                                        {{ blog_date|date:"Y年m月" }} ({{ blog_count }})
                                    </a>
                                </li>
                            {% empty %}
                                <li>暂无此分类</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading"><span class="fa fa-random"></span> &nbsp;随机推荐</div>
                    <div class="panel-body">
                        <ul class="blog-random">
                            {% for blog in blogs_random %}
                                <li>
                                    <a href="{% url 'blog_detail' blog.pk %}">
                                        {{ blog.title }}
                                    </a>
                                </li>
                            {% empty %}
                                <li>暂无此分类</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block script_extends %}
    <script type="text/javascript">
        $(function(){
            var current_page = 0
            $(window).scroll(function(){
                <!--var media_last = $("#ajax_blog").children(".media").last();-->
                <!--var media_height = media_last.height() + 28;-->
                <!--var media_height2 = media_last.offset().top - $(document).scrollTop();-->
                <!--var final_height = $(window).height() - media_height - media_height2;-->
                if(final_height>200){
                    current_page++;
                    $.ajaxSetup({
                        data:{csrfmiddlewaretoken:'{{ csrf_token }}'},
                    });
                    $.ajax({
                        url: "{% url 'ajax_blog' %}",
                        type: 'POST',
                        data: {"start":current_page},
                        dataType: 'text',
                        cache: false,
                        success: function(data){
                            if(data=="{}"){
                                var media_html = '<h3 class="media2">已加载全部文章，感谢您的支持</h2>'
                                $("#ajax_blog").append(media_html)
                                $(".media2").slideDown("slow");
                            }else{
                                var data = JSON.parse(data)
                                var media_html = '<div class="media" style="display:none"><div class="row"><div style="overflow:hidden" class="col-md-3">\
                                                <div class="media-left media-middle"><a href="/blog/'+data['id']+'/">\
                                                <img class="img-rounded" src="/media/'+data['thumbnail']+'" height="150" width="150">\
                                                <figcaption></figcaption></a></div></div><div class="col-md-9"><div class="media-body">\
                                                <h3 class="media-heading"><a href="/blog/'+data['id']+'/">'+data['title']+'</a></h3>\
                                                <div id="content">'+data['content']+'</div><a id="tagset" href="#">\
                                                <button type="button" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-grain"></span> 作者: jet\
                                                </button></a><a href="/blog/type_'+data['type_id']+'"><button type="button" class="btn btn-default btn-xs">\
                                                <span class="glyphicon glyphicon-star-empty"></span> '+data['blog_type']+'</button></a>\
                                                <button type="button" class="btn btn-default btn-xs"><span class="glyphicon glyphicon-time"></span> '+data['created_time']
                                                +'</button><button type="button" class="btn btn-default btn-xs">\
                                                <span class="glyphicon glyphicon-eye-open"></span> 阅读: '+data['read_num']
                                                +'</button><button type="button" class="btn btn-default btn-xs">\
                                                <span class="glyphicon glyphicon-comment"></span> 评论: '+data['comment_num']
                                                +'</button></div></div></div></div>'
                                $("#ajax_blog").append(media_html)
                                $(".media").slideDown("slow");
                            }
                        }
                    });
                }
            });
            // 机器人提示
            function ll3 (){
                $("#music-bar").attr('data-original-title','站长留言：你好，这里是全部文章的显示列表，文章数量不多，还请见谅');
                $("#music-bar").stop().animate({marginLeft:"14px",marginBottom:"14px"},300);
                $("#music-bar").tooltip('show');
            }
            setTimeout(ll3,5000);
        });
    </script>
{% endblock %}